# buildは全体で同じものを使いたい
# それぞれでbuildするのはもったいない
# buildだけじゃなくて、ランタイムとかも同様
# 全体とはいうがOSによって異なるのは許容というか理解できる

# job単位で別のランナー（サーバ）になる
# ので、依存関係がある場合には何かしらの方法で連携する必要がある

# 最終的にはコード解析とテスト、デプロイまでやりたい
# 現時点ではデプロイは不要
# コード解析とテストを直列でやる必要はないので、並列でやる
# コード解析はテストコードとプロダクションコード
# テストもテストの種類によって必要な準備やOSが異なる
# はずなので、それぞれランナーは分けたい=別jobで実行する
# とはいえ、同じOSで良いこともあるのでそこは共通化したい

# 概念として、一つのワークフローにまとめるべき
# な気がしてきた

# 外部のactionを使う場合のみに、actionを使う？
# そういうわけじゃないか
# buildとかでどのOSでも同じ命令になることはありえる

name: 'Check'

on:
  push:

env:
  flutter-version: '3.10.5'
  flutter-channel: 'stable'

jobs:
  build:
    name: 'Build on ${{ matrix.os }}'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v3
      - name: 'Install Flutter'
        uses: ./.github/actions/install-flutter
        with:
          version: ${{ env.flutter-version }}
          channel: ${{ env.flutter-channel }}
      - name: 'Install dependencies'
        uses: ./.github/actions/install-dependencies
      - name: 'Generate Localization code'
        uses: ./.github/actions/generate-localization_code
      - name: 'Build Mocks'
        uses: ./.github/actions/build-mocks

  analyze-production_code:
    name: 'Analyze Production code'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: 'Install Flutter'
        uses: ./.github/actions/install-flutter
        with:
          version: ${{ env.flutter-version }}
          channel: ${{ env.flutter-channel }}
      - name: 'Install dependencies'
        uses: ./.github/actions/install-dependencies
      - name: 'Generate Localization code'
        uses: ./.github/actions/generate-localization_code
      - name: 'Flutter Doctor'
        run: flutter doctor -v
      - name: 'Analyze Production code'
        run: flutter analyze lib

  analyze-test_code:
    name: 'Analyze Test code'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v3
      - name: 'Install Flutter'
        uses: ./.github/actions/install-flutter
        with:
          version: ${{ env.flutter-version }}
          channel: ${{ env.flutter-channel }}
      - name: 'Install dependencies'
        uses: ./.github/actions/install-dependencies
      - name: 'Build Mocks'
        uses: ./.github/actions/build-mocks
      - name: 'Flutter Doctor'
        run: flutter doctor -v
      - name: 'Analyze Test code'
        run: flutter analyze test integration_test

  small_test:
    name: 'Small test'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v3
      - name: 'Install Flutter'
        uses: ./.github/actions/install-flutter
        with:
          version: ${{ env.flutter-version }}
          channel: ${{ env.flutter-channel }}
      - name: 'Install dependencies'
        uses: ./.github/actions/install-dependencies
      - name: 'Build Mocks'
        uses: ./.github/actions/build-mocks
      - name: 'Generate Localization code'
        uses: ./.github/actions/generate-localization_code
      - name: 'Flutter Doctor'
        run: flutter doctor -v
      - id: 'test_execution'
        continue-on-error: true
        run: flutter test --coverage
      - name: 'Upload coverage'
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: small_test
      - name: 'Error handling'
        if: ${{ steps.test_execution.outcome == 'failure' }}
        run: exit 1

  medium_test:
    name: 'Medium test(${{ matrix.platform }})'
    strategy:
      fail-fast: false
      matrix:
        platform: [ windows]
#        platform: [android, windows]
        include:
          - platform: android
            os: macos-latest
            android-api-level: 30
            android-tag: 'default'
            android-abi: 'x86_64'
            java-distribution: 'temurin'
            java-version: 17
          - platform: windows
            os: windows-latest
    runs-on: ${{ matrix.os }}
    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v3
      - name: 'Install Flutter'
        uses: ./.github/actions/install-flutter
        with:
          version: ${{ env.flutter-version }}
          channel: ${{ env.flutter-channel }}
      - name: 'Install dependencies'
        uses: ./.github/actions/install-dependencies
      - name: 'Generate Localization code'
        uses: ./.github/actions/generate-localization_code
      - name: 'Prepare Test for Android'
        if: ${{ matrix.platform == 'android' }}
        uses: ./.github/actions/prepare-test_for-android
        with:
          android-api-level: ${{ matrix.android-api-level }}
          android-tag: ${{ matrix.android-tag }}
          android-abi: ${{ matrix.android-abi }}
          android-sdk-root: ${{ matrix.android-sdk-root }}
          java-distribution: ${{ matrix.java-distribution }}
          java-version: ${{ matrix.java-version }}
      - name: 'Flutter doctor'
        run: flutter doctor -v
      - id: 'test_execution'
        continue-on-error: true
        run: flutter test integration_test/app_test.dart -d ${{ matrix.platform }} --coverage --dart-define=CICD=true
      - name: 'Upload coverage'
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: medium_test-${{ matrix.platform}}
      - name: 'Error handling'
        if: ${{ steps.test_execution.outcome == 'failure' }}
        run: exit 1