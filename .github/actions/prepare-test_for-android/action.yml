name: 'Prepare Test for Android'
inputs:
  android-api-level:
    required: true
  android-tag:
    required: true
  android-abi:
    required: true
  android-sdk-root:
    required: true
  java-distribution:
    required: true
  java-version:
    required: true
runs:
  using: 'composite'
  steps:
    - name: 'Install Android SDK'
      uses: malinskiy/action-android/install-sdk@release/0.1.4
    - name: 'Add env: android-system-images-key'
      run: echo "android-system-images-key=${{ inputs.android-api-level }}-${{ inputs.android-tag }}-${{ inputs.android-abi }}" >> $GITHUB_ENV
      shell: bash
    - name: 'Install Android platform tools'
      run: sdkmanager platform-tools
      shell: bash
    - id: system_images-cache
      name: 'Cache System images'
      uses: actions/cache@v3
      with:
        path: ${{ inputs.android-sdk-root }}/system-images/android-${{ inputs.android-api-level }}/${{ inputs.android-tag }}/${{ inputs.android-abi }}
        key: system_images-${{ env.android-system-images-key }}
    - name: 'Install System images'
      if: steps.system_images-cache.outputs.cache-hit != 'true'
      run: sdkmanager "system-images;android-${{ inputs.android-api-level }};${{ inputs.android-tag }};${{ inputs.android-abi }}"
      shell: bash
# TODO キャッシュしたい。4~6mかかっている
    - name: 'Create Android emulator'
      uses: malinskiy/action-android/emulator-run-cmd@release/0.1.4
      with:
        cmd: flutter doctor -v
        api: ${{ inputs.android-api-level }}
        tag: ${{ inputs.android-tag }}
        abi: ${{ inputs.android-abi }}
    - name: 'Run Android emulator'
      run: $ANDROID_SDK_ROOT/emulator/emulator @emulator -no-snapshot-save -noaudio -no-boot-anim &
      shell: bash
# emulatorが待機状態になるまでの時間をかせぐため、できるだけこれ以降に処理を行う
    - name: 'Install Java'
      uses: actions/setup-java@v3
      with:
        distribution: ${{ inputs.java-distribution }}
        java-version: ${{ inputs.java-version }}
    - name: 'Build for Android'
      run: flutter build apk --debug
      shell: bash
